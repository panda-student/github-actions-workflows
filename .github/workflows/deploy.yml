# 通用部署配置 - 可重用工作流
# 根据分支自动生成镜像标签，无需环境配置文件
name: 通用部署
on:
  workflow_call:
    # 定义可选输入参数
    inputs:
      branch:
        description: '部署分支'
        required: false
        type: string
        default: ${{ github.ref_name }}
      working-directory:
        description: '部署脚本工作目录'
        required: false
        type: string
        default: 'deployment'

jobs:
  deploy:
    name: 部署${{ inputs.branch }}环境
    runs-on: ${{ inputs.branch }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        
      - name: 执行部署
        working-directory: ${{ inputs.working-directory }}
        run: |
          
          # 停止并删除容器
          docker compose down || true
          
          # 清理7天前的旧镜像
          docker images $(basename $GITHUB_WORKSPACE) \
            --filter "before=7 days ago" \
            --format "{{.Repository}}:{{.Tag}}" | xargs -r docker rmi || true
          
          
          # 生成包含日期时间的镜像标签
          export IMAGE_TAG=${{ inputs.branch }}-$(date +%Y%m%d-%H%M%S)
          
          # 获取项目目录名作为镜像名称
          export PROJECT_NAME=$(basename $GITHUB_WORKSPACE)
          
          # 构建镜像并启动容器
          docker compose up -d --build
          
          echo "✅ 部署完成 - 镜像: $PROJECT_NAME:$IMAGE_TAG"